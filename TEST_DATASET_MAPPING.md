# Test Dataset Mapping Documentation

This document maps synthetic test datasets generated by `TestDataFactory` to specific testing scenarios across the order services application.

## Overview

The `TestDataFactory` class in `tests/test_data_factory.py` generates synthetic test data that is completely separated from production data. All datasets use test-specific identifiers (e.g., `TEST-PROD-*`, `TEST-ORD-*`, `TEST-SHIPPER-*`) and fake data patterns to ensure privacy compliance.

---

## Dataset Mappings

### 1. Product Datasets

#### 1.1 `create_product()` - Normal Product Creation
- **Dataset Name**: `create_product`
- **Purpose**: Normal
- **Target Module/Function**: `app.crud.create_product()`
- **Expected Behavior**: 
  - Successfully creates a product with valid attributes
  - Generates product ID automatically
  - Sets default values for optional fields (currency="VND", stock=0, status="ACTIVE")
  - Returns Product model instance with all fields populated

#### 1.2 `create_product_out()` - Product Output Schema
- **Dataset Name**: `create_product_out`
- **Purpose**: Normal
- **Target Module/Function**: `app.routers.products` (GET endpoints)
- **Expected Behavior**:
  - Returns product data in `ProductOut` schema format
  - Includes all product fields including timestamps
  - Used for API response serialization

#### 1.3 `create_product_update()` - Product Update
- **Dataset Name**: `create_product_update`
- **Purpose**: Normal
- **Target Module/Function**: `app.crud.update_product()`
- **Expected Behavior**:
  - Updates product fields with new values
  - Updates `updated_at` timestamp
  - Supports partial updates (only provided fields are updated)

#### 1.4 Product with Custom Price/Stock - Edge Cases
- **Dataset Name**: `create_product(price=X, stock=Y)`
- **Purpose**: Edge
- **Target Module/Function**: `app.crud.create_product()`, `app.crud.update_product()`
- **Expected Behavior**:
  - Handles zero stock (product inactive)
  - Handles very large price values
  - Handles maximum stock values
  - Validates price > 0 (Pydantic validation)

#### 1.5 Product with Negative Values - Abnormal Cases
- **Dataset Name**: `create_product(price=-100, stock=-10)`
- **Purpose**: Abnormal
- **Target Module/Function**: `app.crud.create_product()`, Pydantic validation
- **Expected Behavior**:
  - Raises `ValidationError` for negative price
  - Raises `ValidationError` for negative stock
  - Prevents invalid data from entering the system

---

### 2. Customer Datasets

#### 2.1 `create_customer()` - Normal Customer Data
- **Dataset Name**: `create_customer`
- **Purpose**: Normal
- **Target Module/Function**: `app.crud.create_order()` (embedded in OrderCreate)
- **Expected Behavior**:
  - Creates customer with test-specific name pattern (`TestUser_*`)
  - Generates fake phone number starting with "9"
  - Generates email with `@testdata.example` domain
  - All fields are non-empty strings

#### 2.2 Customer with Empty Fields - Edge Cases
- **Dataset Name**: `Customer(name="", phone="", email=None)`
- **Purpose**: Edge
- **Target Module/Function**: `app.crud.create_order()`
- **Expected Behavior**:
  - Handles empty customer name (may be allowed or rejected)
  - Handles empty phone number
  - Validates email format if provided (Pydantic validation)

---

### 3. Order Datasets

#### 3.1 `create_order()` - Normal Order Creation
- **Dataset Name**: `create_order`
- **Purpose**: Normal
- **Target Module/Function**: `app.crud.create_order()`
- **Expected Behavior**:
  - Creates order with customer and items
  - Generates unique order code (`ORD-YYYYMMDD-HHMMSS-XXXX`)
  - Calculates subtotal from items
  - Calls shipment API and updates shipping status
  - Sets default payment method (COD) and order status (PENDING)

#### 3.2 `create_order_out()` - Order Output Schema
- **Dataset Name**: `create_order_out`
- **Purpose**: Normal
- **Target Module/Function**: `app.routers.orders` (GET endpoints)
- **Expected Behavior**:
  - Returns complete order data in `OrderOut` schema format
  - Includes nested customer, items, pricing, and shipping data
  - Used for API response serialization

#### 3.3 `create_order_update()` - Order Status Update
- **Dataset Name**: `create_order_update`
- **Purpose**: Normal
- **Target Module/Function**: `app.crud.update_order()`
- **Expected Behavior**:
  - Updates order status (DRAFT, CONFIRMED, CANCELLED, COMPLETED)
  - Updates `updated_at` timestamp
  - Validates status transitions

#### 3.4 Order with Multiple Items - Edge Cases
- **Dataset Name**: `create_order(items=[item1, item2, ...])`
- **Purpose**: Edge
- **Target Module/Function**: `app.crud.create_order()`
- **Expected Behavior**:
  - Handles orders with multiple products
  - Calculates subtotal correctly for all items
  - Supports duplicate product IDs in same order

#### 3.5 Order with Empty Items List - Abnormal Cases
- **Dataset Name**: `create_order(items=[])`
- **Purpose**: Abnormal
- **Target Module/Function**: `app.crud.create_order()`
- **Expected Behavior**:
  - May reject empty items list or handle gracefully
  - Shipment API may fail with empty items
  - Weight calculation defaults to minimum 1.0kg

#### 3.6 Order with Non-existent Product - Abnormal Cases
- **Dataset Name**: `create_order(items=[OrderItemCreate(productId="non-existent")])`
- **Purpose**: Abnormal
- **Target Module/Function**: `app.crud.create_order()`
- **Expected Behavior**:
  - Raises `HTTPException` with status 404
  - Error message indicates product not found
  - Order is not created

#### 3.7 Order with Inactive Product - Abnormal Cases
- **Dataset Name**: `create_order(items=[OrderItemCreate(productId=inactive_product.id)])`
- **Purpose**: Abnormal
- **Target Module/Function**: `app.crud.create_order()`
- **Expected Behavior**:
  - Raises `HTTPException` with status 400
  - Error message indicates product is not active
  - Order is not created

#### 3.8 Order with Shipment API Failure - Abnormal Cases
- **Dataset Name**: `create_order()` with mocked shipment API failure
- **Purpose**: Abnormal
- **Target Module/Function**: `app.crud.create_order()`, `app.services.send_order_to_shipment()`
- **Expected Behavior**:
  - Raises `HTTPException` with status 502
  - Error message indicates shipment creation failed
  - Order is rolled back (not saved to database)

---

### 4. OrderItem Datasets

#### 4.1 `create_order_item()` - Normal Order Item
- **Dataset Name**: `create_order_item`
- **Purpose**: Normal
- **Target Module/Function**: `app.crud.create_order()` (embedded in OrderCreate)
- **Expected Behavior**:
  - Creates order item with product ID and quantity
  - Quantity defaults to 1-10 if not specified
  - Used as part of order creation process

#### 4.2 `create_order_item_out()` - Order Item Output Schema
- **Dataset Name**: `create_order_item_out`
- **Purpose**: Normal
- **Target Module/Function**: `app.routers.orders` (GET endpoints)
- **Expected Behavior**:
  - Returns order item data in `OrderItemOut` schema format
  - Includes product name, quantity, unit price, and total price
  - Calculates total price as `unit_price * quantity`

#### 4.3 OrderItem with Zero/Negative Quantity - Abnormal Cases
- **Dataset Name**: `create_order_item(quantity=0)` or `quantity=-1`
- **Purpose**: Abnormal
- **Target Module/Function**: Pydantic validation in `OrderItemCreate`
- **Expected Behavior**:
  - Raises `ValidationError` for zero quantity
  - Raises `ValidationError` for negative quantity
  - Prevents invalid order items

#### 4.4 OrderItem with Very Large Quantity - Edge Cases
- **Dataset Name**: `create_order_item(quantity=2147483647)`
- **Purpose**: Edge
- **Target Module/Function**: `app.crud.create_order()`
- **Expected Behavior**:
  - Handles maximum integer values
  - May not check stock availability (current implementation)
  - Calculates large subtotals correctly

---

### 5. Pricing Datasets

#### 5.1 `create_pricing()` - Normal Pricing Calculation
- **Dataset Name**: `create_pricing`
- **Purpose**: Normal
- **Target Module/Function**: `app.crud.create_order()` (embedded in OrderOut)
- **Expected Behavior**:
  - Calculates subtotal, shipping fee, discount, and total amount
  - Ensures total amount is non-negative (max(0, total))
  - Sets currency to "VND"
  - Used in order output serialization

#### 5.2 Pricing with Discount Exceeding Subtotal - Edge Cases
- **Dataset Name**: `create_pricing(subtotal=100, discount=150)`
- **Purpose**: Edge
- **Target Module/Function**: `create_pricing()` logic
- **Expected Behavior**:
  - Prevents negative total amount
  - Uses `max(0, total_amount)` to ensure non-negative result

#### 5.3 Pricing with Zero/Negative Values - Edge Cases
- **Dataset Name**: `create_pricing(subtotal=0, shipping_fee=-10)`
- **Purpose**: Edge
- **Target Module/Function**: `create_pricing()` logic
- **Expected Behavior**:
  - Handles zero subtotal
  - Handles negative shipping fee (may be allowed for refunds)
  - Ensures final total is non-negative

---

### 6. Address Datasets

#### 6.1 `create_address()` - Normal Address Data
- **Dataset Name**: `create_address`
- **Purpose**: Normal
- **Target Module/Function**: `app.services.send_order_to_shipment()`, `app.services._parse_address()`
- **Expected Behavior**:
  - Creates address with receiver name, phone, and full address
  - Uses test-specific address pattern ("Test Address: ...")
  - Used in shipping information

#### 6.2 Address Parsing - Normal Cases
- **Dataset Name**: Various address strings
- **Purpose**: Normal
- **Target Module/Function**: `app.services._parse_address()`
- **Expected Behavior**:
  - Parses Vietnamese city names (Ho Chi Minh City, Hanoi, Da Nang, etc.)
  - Handles both English and Vietnamese city names
  - Extracts district information when available
  - Defaults to "Ho Chi Minh City" if city not found

#### 6.3 Address Parsing - Edge Cases
- **Dataset Name**: Empty string, None, very long string, special characters only
- **Purpose**: Edge
- **Target Module/Function**: `app.services._parse_address()`
- **Expected Behavior**:
  - Returns default ("Ho Chi Minh City", "", "") for empty/None input
  - Handles very long strings gracefully
  - Handles special characters and numbers only
  - Handles whitespace-only strings

#### 6.4 Address Parsing - Abnormal Cases
- **Dataset Name**: Invalid types (number, list, dict)
- **Purpose**: Abnormal
- **Target Module/Function**: `app.services._parse_address()`
- **Expected Behavior**:
  - Raises `AttributeError` for non-string types
  - Type checking should be done at API level (Pydantic validation)

---

### 7. Shipper Datasets

#### 7.1 `create_shipper()` - Normal Shipper Data
- **Dataset Name**: `create_shipper`
- **Purpose**: Normal
- **Target Module/Function**: `app.services.send_order_to_shipment()`, `app.crud.create_order()`
- **Expected Behavior**:
  - Creates shipper with test-specific ID pattern (`TEST-SHIPPER-*`)
  - Includes name, phone, and vehicle type
  - Used when shipment API returns shipper information

---

### 8. Shipping Datasets

#### 8.1 `create_shipping()` - Normal Shipping Information
- **Dataset Name**: `create_shipping`
- **Purpose**: Normal
- **Target Module/Function**: `app.crud.create_order()`, `app.routers.orders` (GET endpoints)
- **Expected Behavior**:
  - Creates shipping information with status, address, and optional shipper
  - Generates test-specific shipping order code (`TEST-SHIP-*`)
  - Includes estimated delivery time
  - May include delivered_at timestamp if shipment completed

#### 8.2 Shipping with All Statuses - Edge Cases
- **Dataset Name**: `create_shipping(status=X)` where X in [NOT_CREATED, CREATED, PICKED, DELIVERING, DELIVERED, FAILED, CANCELLED]
- **Purpose**: Edge
- **Target Module/Function**: `app.crud.create_order()`, status update endpoints
- **Expected Behavior**:
  - Handles all shipping status transitions
  - Includes failed_reason when status is FAILED
  - Includes shipper information when status is PICKED or later

---

### 9. External Status Update Datasets

#### 9.1 `create_external_status_update()` - Normal Status Update
- **Dataset Name**: `create_external_status_update`
- **Purpose**: Normal
- **Target Module/Function**: `app.routers.orders` (POST /orders/by-code/{order_code}/status-update)
- **Expected Behavior**:
  - Updates order status, payment status, and/or shipping status
  - All fields are optional (may update one or more statuses)
  - Includes optional shipper information
  - Includes optional delivery timestamps

#### 9.2 External Status Update with Partial Fields - Edge Cases
- **Dataset Name**: `create_external_status_update()` with only some fields set
- **Purpose**: Edge
- **Target Module/Function**: `app.routers.orders` (status update endpoint)
- **Expected Behavior**:
  - Updates only provided fields
  - Leaves other fields unchanged
  - Handles None values correctly

---

### 10. Service Integration Datasets

#### 10.1 Shipment API Success - Normal Cases
- **Dataset Name**: Mocked shipment API response with status 200/201
- **Purpose**: Normal
- **Target Module/Function**: `app.services.send_order_to_shipment()`
- **Expected Behavior**:
  - Returns response data dictionary
  - Parses JSON response correctly
  - Handles both status 200 and 201 as success
  - Extracts shipping order code and status

#### 10.2 Shipment API Failure - Abnormal Cases
- **Dataset Name**: Mocked shipment API response with status 400/401/403/500
- **Purpose**: Abnormal
- **Target Module/Function**: `app.services.send_order_to_shipment()`
- **Expected Behavior**:
  - Returns None on failure
  - Logs error message
  - Does not raise exception (graceful failure)

#### 10.3 Shipment API Timeout - Abnormal Cases
- **Dataset Name**: Mocked `httpx.TimeoutException`
- **Purpose**: Abnormal
- **Target Module/Function**: `app.services.send_order_to_shipment()`
- **Expected Behavior**:
  - Returns None
  - Logs timeout error
  - Handles gracefully without crashing

#### 10.4 Shipment API Network Error - Abnormal Cases
- **Dataset Name**: Mocked `httpx.RequestError`, `httpx.ConnectError`
- **Purpose**: Abnormal
- **Target Module/Function**: `app.services.send_order_to_shipment()`
- **Expected Behavior**:
  - Returns None
  - Logs connection error
  - Handles network failures gracefully

#### 10.5 Shipment API Invalid JSON Response - Edge Cases
- **Dataset Name**: Mocked response with status 200/201 but invalid JSON
- **Purpose**: Edge
- **Target Module/Function**: `app.services.send_order_to_shipment()`
- **Expected Behavior**:
  - Returns success indicator with status_code
  - Logs warning about JSON parsing failure
  - Does not crash on JSON parse errors

---

## Test Scenario Categories

### Normal Scenarios
- Standard CRUD operations with valid data
- Successful API integrations
- Expected business logic flows
- Valid data transformations

### Edge Scenarios
- Boundary conditions (zero, maximum values)
- Optional fields (None, empty strings)
- Multiple items/products
- Status transitions
- Partial updates

### Abnormal Scenarios
- Invalid data types
- Validation errors (negative values, empty required fields)
- External API failures
- Network errors
- Database errors
- Missing resources (product not found)

---

## Usage Guidelines

1. **Normal Datasets**: Use for testing happy paths and standard functionality
2. **Edge Datasets**: Use for testing boundary conditions and optional field handling
3. **Abnormal Datasets**: Use for testing error handling and validation

## Privacy Compliance

All datasets generated by `TestDataFactory` comply with privacy requirements:
- No real personal information (names, phones, emails)
- Test-specific identifiers (TEST-* prefixes)
- Fake data patterns clearly distinguishable from production data
- Faker library with seeded random generation for reproducibility

---

## Related Files

- `tests/test_data_factory.py`: Test data generation factory
- `tests/test_data_examples.json`: Example test data in JSON format
- `tests/test_crud.py`: CRUD operation tests
- `tests/test_services.py`: Service layer tests
- `app/crud.py`: Database CRUD operations
- `app/services.py`: External service integrations
- `app/schemas.py`: Pydantic schemas for validation

